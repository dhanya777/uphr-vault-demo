
steps:
# 1. Build the container image using Docker, passing the secret as a build argument
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: [
    '-c',
    "docker build --build-arg VITE_API_KEY_ARG=\"$$_GEMINI_API_KEY\" -t '$_REGION-docker.pkg.dev/$PROJECT_ID/uphr-repo/uphr-vault-frontend:latest' ."
  ]
  secretEnv: ['_GEMINI_API_KEY']

# 2. Push the container image to Google Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'push',
    '$_REGION-docker.pkg.dev/$PROJECT_ID/uphr-repo/uphr-vault-frontend:latest'
  ]

# 3. Deploy the container image to Google Cloud Run (NO LONGER NEEDS SECRET)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args: [
    'run', 'deploy', '$_SERVICE_NAME',
    '--image', '$_REGION-docker.pkg.dev/$PROJECT_ID/uphr-repo/uphr-vault-frontend:latest',
    '--region', '$_REGION',
    '--platform', 'managed',
    '--allow-unauthenticated'
  ]

# Specify the image to be stored in the build results
images:
- '$_REGION-docker.pkg.dev/$PROJECT_ID/uphr-repo/uphr-vault-frontend:latest'

# Define substitutions for variables
substitutions:
  _REGION: 'us-central1'
  _SERVICE_NAME: 'uphr-vault-demo' # Make sure this matches your new service name

# Define the secret to be used
availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/GEMINI_API_KEY/versions/latest
    env: '_GEMINI_API_KEY'
